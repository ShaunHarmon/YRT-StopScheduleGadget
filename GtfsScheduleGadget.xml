<?xml version="1.0" encoding="UTF-8" ?>

<Module>

 <ModulePrefs title="Revel Transit Gadget" description="Displays YRT Transit info for a stop" author="RevelDigital" background="transparent">

 <UserPref name="user_stop_id" display_name="STOP ID(seperate many stop id with a comma)" default_value="" />
 <UserPref name="timeout" display_name="Timeout value in minutes" required="true" default_value="15" />
 <UserPref name="labels" display_name="Labels On" required="true" default_value="true" datatype="bool" /> 
 <UserPref name="rdW" display_name="Width" required="true" default_value="280" datatype="hidden" />
 <UserPref name="rdH" display_name="Height" required="true" default_value="190" datatype="hidden" /> 
	 
 </ModulePrefs>
<Content type="html">

<![CDATA[
 <head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <style>
        #myDiv {
            width: __UP_rdW__px;
            height: __UP_rdH__px;
        }
        
        .stoptable {
            font-family: "Trebuchet MS", Arial, Helvetica, sans-serif;
            border-collapse: collapse;
            width: 100%;
            font-size: 60px;
        }
        
        .stoptable td,
        .stoptable th {
            border: 1px solid #ddd;
            padding: 8px;
        }
        
        .stoptable tr:nth-child(even) {
            background-color: #f2f2f2;
        }
        
        .stoptable tr:nth-child(odd) {
            background-color: #FFFFFF;
        }
        
        .stoptable tr:hover {
            background-color: #ddd;
        }
        
        .stoptable th {
            padding-top: 12px;
            padding-bottom: 12px;
            text-align: left;
            background-color: #000000;
            color: white;
        }
        
        body {
            background: transparent;
        }
    </style>
</head>

<body>
    <div id="myDiv"></div>
    <script>
        //var prefs = new gadgets.Prefs();
        var timeout = .25; //prefs.getString("timeout");
        var stopid = '9819,9820,9821,4461,4468,4453,4454,9723'; //prefs.getString("user_stop_id");
        var stoplist = [];
        var current_index = 0;
        loadStops();
        $(document).ready(function() {
            setInterval("updateList()", timeout * 60000);
        });

        function loadStops() {
            var now = new Date();
            var cur_time = now.toUTCString();
            var offset = now.getTimezoneOffset();
            $.ajax({
                url: "http://localhost:5000/?stop_id=" + stopid + "&current_time=" + now.toUTCString(),
                //url: "https://young-retreat-13285.herokuapp.com/?stop_id=" + stopid + "&current_time=" + cur_time,
                type: 'GET',
                dataType: 'json', // added data type
                //data:{stop_id: '9700'},
                success: function(res) {
                    stoplist = res;
                    console.log(res);
                    var now = new Date();
                    var thirty_min_ahead = new Date();
                    thirty_min_ahead.setMinutes(now.getMinutes() + 60);
                    // Create Table
                    var table = document.createElement('table');
                    table.setAttribute("class", "stoptable");
                    table.setAttribute("id", "stoptable");

                    var table2 = document.createElement('table');
                    table2.setAttribute("class", "stoptable");
                    // Create Table Header Rows
                    // Head row 1
                    var head_row = document.createElement('tr');
                    var table_head = document.createElement('th');
                    var table_head_text = document.createTextNode(res[0].platform_name);
                    table_head.appendChild(table_head_text);
                    head_row.appendChild(table_head);
                    table2.appendChild(head_row);

                    // Head row 2
                    var thr = document.createElement('tr');
                    // Create table headers
                    var th1 = document.createElement('th');
                    var routehead = document.createTextNode('Route');
                    th1.appendChild(routehead);

                    var th2 = document.createElement('th');
                    var destinationhead = document.createTextNode('Destination');
                    th2.appendChild(destinationhead);

                    var th3 = document.createElement('th');
                    var stoptime = document.createTextNode('Departure');
                    th3.appendChild(stoptime);

                    var th4 = document.createElement('th');
                    var platform = document.createTextNode('Platform');
                    th4.appendChild(platform);

                    // Add Headers to Row
                    thr.appendChild(th1);
                    thr.appendChild(th2);
                    thr.appendChild(th3);
                    thr.appendChild(th4);
                    // add header row to Table
                    table.appendChild(thr);
                    var ct = 0;
                    for (var i = 0; len = res.length, i < len; i++) {
                        var stop_time = new Date(res[i].stop_time);
                        stop_time.setMinutes(stop_time.getMinutes());
                        //var stop_time = res[i].stop_time;

                        if (stop_time > now && stop_time < thirty_min_ahead) {
                            var tr = document.createElement('tr');

                            var td1 = document.createElement('td');
                            var td2 = document.createElement('td');
                            var td3 = document.createElement('td');
                            var td4 = document.createElement('td');

                            var text1 = document.createTextNode(res[i].route);
                            var text2 = document.createTextNode(res[i].destination);

                            if (ct < 5) {
                                ct++;
                                var text3 = document.createTextNode("12:59 PM");
                            } else {
                                var text3 = document.createTextNode(stop_time.toLocaleTimeString([], {
                                    hour: '2-digit',
                                    minute: '2-digit'
                                }));
                            }
                            var text4 = document.createTextNode(res[i].platform_number);

                            td1.appendChild(text1);
                            td2.appendChild(text2);
                            td3.appendChild(text3);
                            td4.appendChild(text4);

                            tr.appendChild(td1);
                            tr.appendChild(td2);
                            tr.appendChild(td3);
                            tr.appendChild(td4);

                            table.appendChild(tr);

                            current_index = i;
                        }
                    }
                    document.getElementById("myDiv").appendChild(table2);
                    document.getElementById("myDiv").appendChild(table);
                }
            });
        }

        function addRow(row, table) {
            var stop_time = new Date(row.stop_time);
            stop_time.setMinutes(stop_time.getMinutes());

            var tr = document.createElement('tr');

            var td1 = document.createElement('td');
            var td2 = document.createElement('td');
            var td3 = document.createElement('td');
            var td4 = document.createElement('td');

            var text1 = document.createTextNode(row.route);
            var text2 = document.createTextNode(row.destination);
            var text3 = document.createTextNode(stop_time.toLocaleTimeString([], {
                hour: '2-digit',
                minute: '2-digit'
            }));
            var text4 = document.createTextNode(row.platform_number);

            td1.appendChild(text1);
            td2.appendChild(text2);
            td3.appendChild(text3);
            td4.appendChild(text4);

            tr.appendChild(td1);
            tr.appendChild(td2);
            tr.appendChild(td3);
            tr.appendChild(td4);

            table.appendChild(tr);
        }

        function formatAMPM(date) {
            var hours = date.getHours();
            var minutes = date.getMinutes();
            var ampm = hours >= 12 ? 'PM' : 'AM';
            hours = hours % 12;
            hours = hours ? hours : 12; // the hour '0' should be '12'
            minutes = minutes < 10 ? '0' + minutes : minutes;
            var strTime = hours + ':' + minutes + ' ' + ampm;
            return strTime;
        }


        function updateList() {
            //$("#stoptable").slideUp(2000);
            var table = document.getElementById("stoptable");
            //do what you need here
            //elem.parentNode.removeChild(elem);
            var now = new Date();
            //console.log(now);
            //var nowStr = formatAMPM(now);
            // get now hour min

            numDeleted = 0;
            for (var x = 1; x < table.rows.length; x++) {
                var departureDate = new Date();
                var departure = table.rows[x].cells[2].innerHTML;
                var departureArray = departure.split(":");
                var departureHour = departureArray[0];
                var departureMin = departureArray[1]
                var departureMinArray = departureMin.split(" ");
                departureMin = departureMinArray[0];
                if (departureMinArray[1] == "PM" && departureHour < 12) {
                    departureHour = departureHour + 12;
                }

                departureDate.setHours(departureHour);
                departureDate.setMinutes(departureMin);
                //console.log(departureDate);

                if (now > departureDate) {
                    //console.log(departureDate);
                    //console.log(table.rows[1]);
                    table.deleteRow(1);
                    numDeleted++;
                }
            }
            for (var y = 0; y < numDeleted; y++) {
                current_index++;
                //console.log(stoplist[current_index]);
                addRow(stoplist[current_index], table);
            }

        }

        var my_time;
        $(document).ready(function() {
            pageScroll();
            $("#myDiv").mouseover(function() {
                clearTimeout(my_time);
            }).mouseout(function() {
                pageScroll();
            });
        });

        function pageScroll() {
            var objDiv = document.getElementById("myDiv");
            objDiv.scrollTop = objDiv.scrollTop + 1;
            $('p:nth-of-type(1)').html('scrollTop : ' + objDiv.scrollTop);
            $('p:nth-of-type(2)').html('scrollHeight : ' + objDiv.scrollHeight);
            if (objDiv.scrollTop == (objDiv.scrollHeight - objDiv.offsetHeight)) {
                objDiv.scrollTop = 0;
            }
            my_time = setTimeout('pageScroll()', 25);
        }
    </script>
</body>
 ]]>
 </Content>

</Module>
